---
- name: Define OS9 credentials from AWS securet
  set_fact:
    ansible_ssh_user: "{{ sw_secret['user'] }}"
    ansible_ssh_pass: "{{ sw_secret['pass'] }}"
    ansible_become_pass: "{{ sw_secret['pass'] }}"

# Set Connection Parameters
- name: Set Conn Parameters
  dellemc.os9.os9_config:
    lines:
      - ip ssh connection-rate-limit 60

# Set the hostname of the switch to the value in the hosts file
- name: Set Hostname
  dellemc.os9.os9_config:
    lines:
      - hostname {{ inventory_hostname }}

# Gather the current output of "show running configuration" on the switch
- name: Gather Current Configuration
  dellemc.os9.os9_facts:
    gather_subset:
      - config
  register: cur_config

- name: Apply Manifest Configuration
  dellemc.os9.os9_config:
    lines: "{{ item }}"
    replace: block
    match: none
  loop: "{{ cur_config | OS9_GETCONFIG(interfaces, vlans) }}"

- name: Clean Deleted Interfaces
  dellemc.os9.os9_config:
    lines: "{{ cur_config | OS9_CLEANINTF(interfaces, vlans) }}"
    replace: block
    match: none

- name: Save Configuration
  dellemc.os9.os9_config:
    save: yes